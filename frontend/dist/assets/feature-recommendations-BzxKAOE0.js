var G=Object.defineProperty,J=Object.defineProperties;var X=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var L=(e,t,a)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,F=(e,t)=>{for(var a in t||(t={}))Z.call(t,a)&&L(e,a,t[a]);if(M)for(var a of M(t))ee.call(t,a)&&L(e,a,t[a]);return e},I=(e,t)=>J(e,X(t));var u=(e,t,a)=>new Promise((r,o)=>{var d=c=>{try{n(a.next(c))}catch(l){o(l)}},s=c=>{try{n(a.throw(c))}catch(l){o(l)}},n=c=>c.done?r(c.value):Promise.resolve(c.value).then(d,s);n((a=a.apply(e,t)).next())});import{C as O,B as Y,h as U,n as te,r as w,u as ae,b as ie,e as re,L as se,E as ne}from"./shared-B32_tFWT.js";import{j as i}from"./feature-admin-Bw8S4RZv.js";import{e as $,r as C}from"./chart-vendor-C7uCl44m.js";import{u as oe}from"./feature-fields-fUbMVOqT.js";import{u as le,a as de,b as ce}from"./query-vendor-B8e9_Lvn.js";import{g as me}from"./feature-health-Ft4uQN76.js";import{g as he}from"./feature-weather-C6tNy8il.js";import{g as pe}from"./feature-yield-DIh4ls_q.js";import{b as ue,a as fe}from"./router-vendor-D1DOKBjT.js";import"./map-vendor-BIpNu-NE.js";import"./http-vendor-DnTtldoj.js";const ge={planned:{label:"Planned",className:"bg-blue-50 text-blue-800 border border-blue-100"},applied:{label:"Applied",className:"bg-green-50 text-green-800 border border-green-100"},overdue:{label:"Overdue",className:"bg-red-50 text-red-800 border border-red-100"}},ye={high:{label:"High",className:"bg-red-50 text-red-800 border border-red-100"},medium:{label:"Medium",className:"bg-amber-50 text-amber-800 border border-amber-100"},low:{label:"Low",className:"bg-slate-50 text-slate-700 border border-slate-200"}},H=e=>{if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?e:t.toLocaleDateString()},z=({recommendation:e,onApply:t,isApplying:a=!1})=>{const{id:r,title:o,description:d,status:s,priority:n,recommendedAt:c,applyBefore:l,appliedAt:m,weatherHint:p}=e,v=ge[s],g=ye[n],b=`recommendation-${r}-title`,N=H(c),j=H(l),y=H(m),A=(s==="planned"||s==="overdue")&&!!t,x=()=>{t&&t(r)};return i.jsx("article",{"aria-labelledby":b,className:"flex flex-col",children:i.jsxs(O,{className:"h-full",children:[i.jsxs("header",{className:"flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between",children:[i.jsxs("div",{className:"space-y-1",children:[i.jsx("h3",{id:b,className:"text-sm font-semibold text-gray-900",children:o}),i.jsx("p",{className:"text-xs text-gray-600",children:d})]}),i.jsxs("div",{className:"flex flex-wrap gap-2 mt-2 sm:mt-0",children:[i.jsxs("span",{className:$("inline-flex items-center rounded-full px-2.5 py-1 text-[11px] font-medium",v.className),children:["Status: ",v.label]}),i.jsxs("span",{className:$("inline-flex items-center rounded-full px-2.5 py-1 text-[11px] font-medium",g.className),children:["Priority: ",g.label]})]})]}),i.jsxs("div",{className:"mt-3 space-y-2 text-xs text-gray-600",children:[N&&i.jsxs("p",{children:[i.jsx("span",{className:"font-medium text-gray-700",children:"Recommended on:"})," ",N]}),j&&i.jsxs("p",{children:[i.jsx("span",{className:"font-medium text-gray-700",children:"Apply before:"})," ",j]}),y&&i.jsxs("p",{children:[i.jsx("span",{className:"font-medium text-gray-700",children:"Applied on:"})," ",y]})]}),p&&i.jsx("div",{className:"mt-3",children:i.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-sky-200 bg-sky-50 px-2.5 py-1 text-[11px] font-medium text-sky-800",children:[i.jsx("span",{"aria-hidden":"true",children:"â˜"}),i.jsx("span",{className:"uppercase tracking-wide",children:"Weather hint"}),i.jsx("span",{className:"sr-only",children:":"}),i.jsx("span",{className:"normal-case font-normal",children:p})]})}),i.jsxs("div",{className:"mt-4 flex items-center justify-between gap-2",children:[i.jsx("p",{className:"text-[11px] text-gray-500",children:s==="applied"?"This recommendation has been marked as applied.":"Review and apply this recommendation when appropriate."}),A&&i.jsx(Y,{size:"sm",variant:s==="overdue"?"primary":"secondary",onClick:x,disabled:a,"aria-label":a?`Saving application for recommendation "${o}"`:`Mark recommendation "${o}" as applied`,children:a?"Savingâ€¦":"Mark as applied"})]})]})})},_={overdue:0,planned:1,applied:2},P={high:0,medium:1,low:2},xe=e=>[...e].sort((t,a)=>{const r=_[t.status]-_[a.status];if(r!==0)return r;const o=P[t.priority]-P[a.priority];if(o!==0)return o;const d=Date.parse(t.recommendedAt),s=Date.parse(a.recommendedAt);return!Number.isNaN(d)&&!Number.isNaN(s)?d-s:0}),we=e=>[...e].sort((t,a)=>{const r=t.appliedAt?Date.parse(t.appliedAt):0;return(a.appliedAt?Date.parse(a.appliedAt):0)-r}),ve=({recommendations:e,onApply:t,applyingId:a})=>{const r=e.filter(l=>l.status==="planned"||l.status==="overdue"),o=e.filter(l=>l.status==="applied"),d=xe(r),s=we(o),n=d.length>0,c=s.length>0;return!n&&!c?i.jsx("div",{className:"rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-6 text-sm text-gray-600",children:"No recommendations available yet. As health and weather signals update, this panel will surface prioritized actions for this field."}):i.jsxs("div",{className:"space-y-6",children:[n&&i.jsxs("section",{"aria-labelledby":"upcoming-recommendations-heading",className:"space-y-3",children:[i.jsxs("header",{className:"flex items-baseline justify-between gap-2",children:[i.jsx("h2",{id:"upcoming-recommendations-heading",className:"text-sm font-semibold text-gray-900",children:"Upcoming actions"}),i.jsx("p",{className:"text-xs text-gray-500",children:"Overdue items appear first, followed by planned actions by priority."})]}),i.jsx("div",{className:"space-y-3",children:d.map(l=>i.jsx(z,{recommendation:l,onApply:t,isApplying:a===l.id},l.id))})]}),c&&i.jsxs("section",{"aria-labelledby":"history-recommendations-heading",className:"space-y-3",children:[i.jsxs("header",{className:"flex items-baseline justify-between gap-2",children:[i.jsx("h2",{id:"history-recommendations-heading",className:"text-sm font-semibold text-gray-900",children:"History"}),i.jsx("p",{className:"text-xs text-gray-500",children:"Applied recommendations, with the most recent actions first."})]}),i.jsx("div",{className:"space-y-3",children:s.map(l=>i.jsx(z,{recommendation:l,onApply:t,isApplying:a===l.id},l.id))})]})]})},De={id:"critical-health",condition:e=>e.healthData!==void 0&&e.healthData.ndvi<.4&&e.healthData.trend==="declining",priority:"high",generate:e=>{var t;return{title:"ðŸš¨ Urgent: Severe Stress Detected",description:`Your field shows critical stress with NDVI of ${e.healthData.ndvi.toFixed(2)}. Immediate action required to prevent crop failure.`,status:"overdue",priority:"high",applyBefore:h(2),weatherHint:(t=e.weatherData)==null?void 0:t.forecast}}},be={id:"water-stress",condition:e=>e.healthData!==void 0&&e.healthData.ndvi<.6&&e.weatherData!==void 0&&e.weatherData.rainfall<10&&(e.lastIrrigationDays===void 0||e.lastIrrigationDays>7),priority:"high",generate:e=>{var a;const t=e.lastIrrigationDays||"unknown";return{title:"ðŸ’§ Apply Irrigation",description:`Low rainfall (${e.weatherData.rainfall}mm) and declining health indicate water stress. Last irrigation: ${t} days ago.`,status:"planned",priority:"high",applyBefore:h(3),weatherHint:((a=e.weatherData)==null?void 0:a.forecast)||"Dry conditions expected"}}},Ne={id:"vegetative-fertilizer",condition:e=>e.growthStage==="vegetative"&&(e.lastFertilizerDays===void 0||e.lastFertilizerDays>15)&&e.healthData!==void 0&&e.healthData.ndvi<.7,priority:"medium",generate:e=>{var t;return{title:"ðŸŒ± Apply Nitrogen Fertilizer",description:`Your field is in the vegetative stage and needs nitrogen boost. Current NDVI: ${e.healthData.ndvi.toFixed(2)}. Recommended: 40kg/ha urea.`,status:"planned",priority:"medium",applyBefore:h(7),weatherHint:(t=e.weatherData)==null?void 0:t.forecast}}},je={id:"reproductive-fertilizer",condition:e=>e.growthStage==="reproductive"&&(e.lastFertilizerDays===void 0||e.lastFertilizerDays>20),priority:"medium",generate:e=>({title:"ðŸŒ¾ Apply Phosphorus & Potassium",description:"Your paddy is flowering. Apply P&K fertilizer to boost grain formation. Recommended: 30kg/ha NPK (0-20-20).",status:"planned",priority:"medium",applyBefore:h(5),weatherHint:"Apply when no rain expected for 2 days"})},Ae={id:"pest-risk",condition:e=>e.weatherData!==void 0&&e.weatherData.humidity>80&&e.healthData!==void 0&&e.healthData.healthStatus==="good"&&e.growthStage==="reproductive",priority:"medium",generate:e=>({title:"ðŸ› Monitor for Pests",description:`High humidity (${e.weatherData.humidity}%) during flowering increases pest risk. Inspect for brown plant hopper and leaf folder.`,status:"planned",priority:"medium",applyBefore:h(3),weatherHint:"Monitor daily until humidity drops"})},Re={id:"drain-before-rain",condition:e=>e.weatherData!==void 0&&e.weatherData.forecast!==void 0&&e.weatherData.forecast.toLowerCase().includes("heavy rain"),priority:"high",generate:e=>({title:"ðŸŒ§ï¸ Drain Excess Water",description:`Heavy rain forecast: "${e.weatherData.forecast}". Drain field to prevent waterlogging and disease.`,status:"planned",priority:"high",applyBefore:h(1),weatherHint:e.weatherData.forecast})},Se={id:"harvest-timing",condition:e=>e.growthStage==="ripening"&&e.healthData!==void 0&&e.healthData.ndvi<.5,priority:"high",generate:e=>({title:"ðŸŒ¾ Prepare for Harvest",description:`NDVI declining to ${e.healthData.ndvi.toFixed(2)} indicates ripening complete. Plan harvest within 1-2 weeks for optimal yield.`,status:"planned",priority:"high",applyBefore:h(7),weatherHint:"Harvest on a sunny day to avoid grain moisture issues"})},Fe={id:"maintain-health",condition:e=>e.healthData!==void 0&&e.healthData.trend==="improving"&&e.healthData.healthStatus==="excellent",priority:"low",generate:e=>({title:"âœ… Continue Current Practices",description:`Your field health is improving (NDVI: ${e.healthData.ndvi.toFixed(2)}). Maintain current irrigation and fertilization schedule.`,status:"planned",priority:"low",weatherHint:"Monitor for any sudden changes"})},Ie={id:"yield-boost",condition:e=>e.yieldData!==void 0&&e.yieldData.predictedYield<3500&&e.growthStage==="vegetative",priority:"medium",generate:e=>({title:"ðŸ“Š Yield Below Target",description:`Predicted yield: ${e.yieldData.predictedYield}kg/ha. Increase fertilizer and ensure consistent water supply to reach 4000kg/ha target.`,status:"planned",priority:"medium",applyBefore:h(10),weatherHint:"Act now while plants are still in growth phase"})},He={id:"disease-risk",condition:e=>e.healthData!==void 0&&e.healthData.trend==="declining"&&e.weatherData!==void 0&&e.weatherData.rainfall>50,priority:"high",generate:e=>({title:"ðŸ¦  Disease Risk Detected",description:`Declining health with heavy rainfall (${e.weatherData.rainfall}mm) suggests possible fungal disease. Inspect for blast or sheath blight.`,status:"planned",priority:"high",applyBefore:h(2),weatherHint:"Apply fungicide if disease confirmed"})},Te=[De,be,Re,He,Ne,je,Se,Ae,Ie,Fe],ke=e=>{const t=[];for(const a of Te)try{if(a.condition(e)){const r=a.generate(e);t.push(I(F({},r),{id:`ai-${a.id}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,fieldId:e.fieldId,recommendedAt:new Date().toISOString()}))}}catch(r){console.warn(`Rule ${a.id} failed:`,r)}return t.sort((a,r)=>{const o={high:0,medium:1,low:2};return o[a.priority]-o[r.priority]}),t.slice(0,5)};function h(e){const t=new Date;return t.setDate(t.getDate()+e),t.toISOString()}const Be=e=>e==="low"?"low":e==="high"?"high":"medium",Me=e=>{var o,d;const t=e.details,a=(o=t==null?void 0:t.applied_at)!=null?o:null,r=(d=t==null?void 0:t.apply_before)!=null?d:null;if(a)return"applied";if(r){const s=Date.now(),n=Number.isNaN(Date.parse(r))?null:Date.parse(r);if(n!==null&&n<s)return"overdue"}return"planned"},q=e=>{var a,r,o,d;const t=e.details;return{id:e.id,fieldId:e.field_id,title:(r=(a=t==null?void 0:t.title)!=null?a:e.reason)!=null?r:`Recommendation for ${e.type}`,description:(d=(o=t==null?void 0:t.description)!=null?o:e.reason)!=null?d:"",status:Me(e),priority:Be(e.severity),recommendedAt:e.timestamp,applyBefore:t==null?void 0:t.apply_before,appliedAt:t==null?void 0:t.applied_at,weatherHint:t==null?void 0:t.weather_hint}},Le=e=>u(void 0,null,function*(){var t;try{const r=((t=(yield U.get(`/fields/${e}/recommendations`)).data.data)!=null?t:[]).map(q);return r.length>0?r:yield E(e)}catch(a){console.log("Backend recommendations failed, using AI generation:",a);try{return yield E(e)}catch(r){return console.error("AI recommendation generation failed:",r),[]}}});function E(e){return u(this,null,function*(){try{const[t,a,r]=yield Promise.allSettled([$e(e),Ce(e),ze(e)]),o={fieldId:e,fieldName:"Field",areaHa:1,healthData:t.status==="fulfilled"?t.value:void 0,weatherData:a.status==="fulfilled"?a.value:void 0,yieldData:r.status==="fulfilled"?r.value:void 0,growthStage:_e(),lastIrrigationDays:Math.floor(Math.random()*10),lastFertilizerDays:Math.floor(Math.random()*20)};return ke(o)}catch(t){return console.error("Error generating AI recommendations:",t),[]}})}function $e(e){return u(this,null,function*(){var t,a;try{const r=new Date().toISOString().split("T")[0],o=new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0],d=yield me(e,{startDate:o,endDate:r,indexType:"NDVI"}),s=(t=d.latestIndex)!=null?t:.5,n=((a=d.timeSeries.find(m=>m.indexType==="NDVI"))==null?void 0:a.points)||[];let c="stable";if(n.length>=2){const m=n[n.length-1].value,p=n[n.length-2].value;m>p+.05?c="improving":m<p-.05&&(c="declining")}let l="good";return s>.7?l="excellent":s>.5?l="good":s>.3?l="fair":l="poor",{ndvi:s,healthStatus:l,trend:c,timeSeries:n}}catch(r){console.warn("Failed to fetch health data for AI:",r);return}})}function Ce(e){return u(this,null,function*(){try{const a=(yield he(7.9403,81.0188)).daily.slice(0,7),r=a.reduce((s,n)=>s+(n.precipMm||0),0),o=a.length>0?a.reduce((s,n)=>s+(n.minTempC+n.maxTempC)/2,0)/a.length:30,d=a.some(s=>{var n;return((n=s.condition)==null?void 0:n.toLowerCase().includes("rain"))||s.precipMm&&s.precipMm>20});return{temperature:o,rainfall:r,humidity:75,forecast:d?"Heavy rain expected in next week":"Normal weather conditions"}}catch(t){return console.warn("Failed to fetch weather data for AI:",t),{temperature:28+Math.random()*4,rainfall:Math.random()*30,humidity:70+Math.random()*20}}})}function ze(e){return u(this,null,function*(){try{const a=(yield pe({features:[{field_id:e,ndvi_mean:.65,rainfall_mm:100,temperature_c:30}]})).predictions[0];return{predictedYield:(a==null?void 0:a.yield_kg_per_ha)||4e3,lastActualYield:a==null?void 0:a.previous_season_yield}}catch(t){console.warn("Failed to fetch yield data for AI:",t);return}})}function _e(){const e=new Date().getMonth();return e===0||e===1||e===5||e===6?"vegetative":e===2||e===7?"reproductive":e===3||e===8?"ripening":"harvest"}const Pe=(e,t)=>u(void 0,null,function*(){try{const a={};t!=null&&t.appliedAt&&(a.appliedAt=t.appliedAt);const r=yield U.post(`/recommendations/${e}/apply`,a);return q(r.data.data)}catch(a){throw te(a)}}),Ee=e=>le({queryKey:w.field(e),queryFn:()=>Le(e),enabled:!!e}),Oe=()=>{const e=de();return ce({mutationFn:({id:t,payload:a})=>Pe(t,a),onMutate:o=>u(void 0,[o],function*({fieldId:t,id:a,payload:r}){var n;yield e.cancelQueries({queryKey:w.field(t)});const d=e.getQueryData(w.field(t)),s=(n=r==null?void 0:r.appliedAt)!=null?n:new Date().toISOString();if(d){const c=d.map(l=>l.id===a?I(F({},l),{status:"applied",appliedAt:s}):l);e.setQueryData(w.field(t),c)}return{previousRecommendations:d}}),onError:(t,{fieldId:a},r)=>{r!=null&&r.previousRecommendations&&e.setQueryData(w.field(a),r.previousRecommendations)},onSettled:(t,a,{fieldId:r})=>{e.invalidateQueries({queryKey:w.field(r)})}})},tt=()=>{var T,k,B;const{fieldId:e}=ue(),t=fe(),{showToast:a}=ae(),{state:{currentFieldId:r},setCurrentField:o}=ie(),{isOnline:d}=re(),s=(T=e!=null?e:r)!=null?T:"";C.useEffect(()=>{e&&o(e)},[e,o]);const{data:n,isLoading:c,isError:l}=oe(s),{data:m,isLoading:p,isError:v,error:g,refetch:b,isFetching:N}=Ee(s),{mutate:j}=Oe(),[y,A]=C.useState(null),x=((k=m==null?void 0:m.length)!=null?k:0)>0,Q=()=>{b(),a({title:"Retrying recommendations",description:"Attempting to reload recommendations for this field.",variant:"default"})},V=R=>{if(!s){a({title:"No field selected",description:"Unable to apply this recommendation because the field could not be determined.",variant:"error"});return}const K=new Date().toISOString();A(R),j({id:R,fieldId:s,payload:{appliedAt:K}},{onSuccess:()=>{var D;const f=(m!=null?m:[]).find(W=>W.id===R),S=(D=f==null?void 0:f.title)!=null?D:"Recommendation";a({title:"Recommendation applied",description:`"${S}" was marked as applied.`,variant:"success"})},onError:f=>{var D;const S=(D=f==null?void 0:f.message)!=null?D:"Failed to apply recommendation.";a({title:"Could not apply recommendation",description:S,variant:"error"})},onSettled:()=>{A(null)}})};return e?i.jsxs("section",{"aria-labelledby":"field-recommendations-heading",className:"space-y-4",children:[i.jsxs("header",{className:"space-y-1",children:[i.jsx("h1",{id:"field-recommendations-heading",className:"text-lg font-semibold text-gray-900",children:"Recommendations"}),i.jsx("p",{className:"text-sm text-gray-600",children:"These actions are tailored to your fieldâ€™s current health and recent weather conditions. Use them to plan irrigation, fertilization, and risk mitigation."}),i.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-3 text-xs text-gray-500",children:[n&&!c&&!l&&i.jsxs(i.Fragment,{children:[i.jsx("span",{className:"font-medium text-gray-700",children:n.name}),i.jsxs("span",{children:["Area: ",n.areaHa.toFixed(2)," ha"]})]}),N&&i.jsx("span",{children:"Refreshingâ€¦"})]})]}),!d&&i.jsxs("p",{className:"flex items-center gap-2 text-xs text-amber-700",children:[i.jsx("span",{className:"inline-block h-2 w-2 rounded-full bg-amber-500","aria-hidden":"true"}),x?"You are offline. Showing the last loaded recommendations.":"You are offline and have no cached recommendations yet."]}),p&&!x&&i.jsx(se,{message:"Loading recommendations for this fieldâ€¦"}),v&&i.jsx(ne,{title:"Unable to load recommendations",message:(B=g==null?void 0:g.message)!=null?B:"Something went wrong while loading recommendations for this field.",onRetry:Q}),!p&&!v&&!x&&i.jsx(O,{title:"No recommendations yet",children:i.jsx("p",{className:"text-sm text-gray-700",children:"There are no active recommendations for this field yet. As health and weather signals update, prioritized actions will appear here."})}),x&&i.jsx(ve,{recommendations:m!=null?m:[],onApply:V,applyingId:y!=null?y:void 0})]}):i.jsxs("section",{"aria-labelledby":"field-recommendations-heading",className:"space-y-4",children:[i.jsxs("header",{className:"space-y-1",children:[i.jsx("h1",{id:"field-recommendations-heading",className:"text-lg font-semibold text-gray-900",children:"Field not found"}),i.jsx("p",{className:"text-sm text-gray-600",children:"The requested field could not be identified from the URL. Please return to your fields list and try again."})]}),i.jsx(Y,{size:"sm",variant:"secondary",onClick:()=>t("/fields"),children:"Back to fields"})]})};export{tt as FieldRecommendationsPage,tt as default};
