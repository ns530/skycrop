var v=(t,s,a)=>new Promise((r,n)=>{var l=o=>{try{c(a.next(o))}catch(x){n(x)}},d=o=>{try{c(a.throw(o))}catch(x){n(x)}},c=o=>o.done?r(o.value):Promise.resolve(o.value).then(l,d);c((a=a.apply(t,s)).next())});import{B as T,C as u,h as M,n as A,m as V,u as q,b as K,e as _,L as Y,E as X}from"./shared-BOarZger.js";import{j as e,u as $,g as Q,r as p}from"./react-vendor-CXQW5CXM.js";import{u as J}from"./feature-fields-2FR36cYB.js";import{R as Z,L as ee,C as te,X as ae,Y as se,T as re,a as ne,b as w,c as le}from"./chart-vendor-Ca9tAmf7.js";const ie=({indexType:t,onIndexChange:s,range:a,onRangeChange:r})=>{const n=[{value:"NDVI",label:"NDVI"},{value:"NDWI",label:"NDWI"},{value:"TDVI",label:"TDVI"}],l=[{value:"7d",label:"7 days"},{value:"14d",label:"14 days"},{value:"30d",label:"30 days"},{value:"season",label:"Season"}];return e.jsxs("section",{"aria-label":"Health index and date range selection",className:"flex flex-col gap-3 rounded-md border border-gray-100 bg-white p-3 sm:p-4",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-gray-500",children:"Index"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Choose which vegetation or water index to view."})]}),e.jsx("div",{role:"radiogroup","aria-label":"Select health index",className:"mt-1 inline-flex flex-wrap gap-2",children:n.map(d=>{const c=d.value===t;return e.jsx(T,{type:"button",size:"sm",variant:c?"primary":"ghost","aria-pressed":c,onClick:()=>s(d.value),children:d.label},d.value)})})]}),e.jsx("div",{className:"h-px w-full bg-gray-100","aria-hidden":"true"}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium uppercase tracking-wide text-gray-500",children:"Date range"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Summaries are computed for the selected lookback window."})]}),e.jsx("div",{role:"radiogroup","aria-label":"Select health date range",className:"mt-1 inline-flex flex-wrap gap-2",children:l.map(d=>{const c=d.value===a;return e.jsx(T,{type:"button",size:"sm",variant:c?"secondary":"ghost","aria-pressed":c,onClick:()=>r(d.value),children:d.label},d.value)})})]})]})},de=[{label:"Excellent",rangeHint:"0.8 â€“ 1.0",colorClass:"bg-status-excellent"},{label:"Good",rangeHint:"0.6 â€“ 0.8",colorClass:"bg-status-excellent/80"},{label:"Fair",rangeHint:"0.4 â€“ 0.6",colorClass:"bg-status-fair"},{label:"Poor",rangeHint:"0.0 â€“ 0.4",colorClass:"bg-status-poor"}],oe=t=>{switch(t){case"NDVI":return"NDVI (Normalized Difference Vegetation Index) approximates green biomass and vigor. Higher values usually indicate healthier vegetation.";case"NDWI":return"NDWI (Normalized Difference Water Index) highlights leaf water content and surface moisture. Higher values may indicate wetter conditions.";case"TDVI":return"TDVI (Transformed Difference Vegetation Index) is a variation of NDVI that can be more robust in certain lighting or soil conditions.";default:return"Vegetation index values are normalized between 0 and 1. These ranges will align with the colors used on the map overlay."}},ce=({indexType:t})=>e.jsx(u,{title:`${t} legend`,children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-gray-600",children:oe(t)}),e.jsx("ul",{className:"space-y-2 text-xs text-gray-700","aria-label":`${t} color legend`,children:de.map(s=>e.jsxs("li",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-flex h-3 w-3 rounded-full ${s.colorClass}`,"aria-hidden":"true"}),e.jsx("span",{className:"font-medium",children:s.label})]}),e.jsx("span",{className:"tabular-nums text-gray-500",children:s.rangeHint})]},s.label))})]})}),xe=t=>t==="Excellent"||t==="Good"?"excellent":t==="Fair"?"fair":t==="Poor"?"poor":"default",he=t=>t==="Excellent"||t==="Good"?"text-emerald-700":t==="Fair"?"text-amber-700":t==="Poor"?"text-red-700":"text-gray-400",me=({statusLabel:t,latestIndex:s,lastUpdated:a})=>{const r=!t,n=typeof s=="number"?s.toFixed(2):"â€”",l=a?new Date(a).toLocaleString():"â€”";return e.jsx(u,{title:"Field health",status:xe(t),showStatusStripe:!r,"aria-label":"Field health status",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Overall status"}),e.jsx("p",{className:`mt-1 text-2xl font-semibold ${he(t)}`,children:r?"No data":t})]}),e.jsxs("div",{className:"flex flex-wrap items-baseline gap-x-6 gap-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Latest NDVI"}),e.jsx("p",{className:"mt-0.5 font-medium text-gray-900",children:n})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Last updated"}),e.jsx("p",{className:"mt-0.5 text-xs text-gray-600",children:l})]})]})]})})},E=t=>{switch(t){case"Excellent":case"Good":return"bg-status-excellent";case"Fair":return"bg-status-fair";case"Poor":return"bg-status-poor";default:return"bg-gray-200"}},ge=({buckets:t})=>{if(!t||t.length===0)return e.jsx("p",{className:"text-sm text-gray-600",children:"No area breakdown is available for this period."});const s=t.reduce((a,r)=>a+r.percentageArea,0)||1;return e.jsxs("div",{className:"space-y-3","aria-label":"Field area by health status",children:[e.jsx("div",{className:"flex h-3 overflow-hidden rounded-full bg-gray-100",role:"img","aria-label":"Health bucket distribution",children:t.map(a=>{const r=`${a.percentageArea/s*100}%`;return e.jsx("div",{className:`${E(a.label)} first:rounded-l-full last:rounded-r-full`,style:{width:r},children:e.jsxs("span",{className:"sr-only",children:[a.label,": ",a.percentageArea.toFixed(0),"%"]})},a.label)})}),e.jsx("ul",{className:"grid grid-cols-1 gap-2 text-xs text-gray-700 sm:grid-cols-2","aria-label":"Health bucket legend",children:t.map(a=>e.jsxs("li",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`inline-flex h-2.5 w-2.5 rounded-full ${E(a.label)}`,"aria-hidden":"true"}),e.jsx("span",{className:"font-medium",children:a.label})]}),e.jsxs("span",{"aria-label":`${a.label} area percentage`,children:[a.percentageArea.toFixed(0),"%"]})]},a.label))})]})},ue=t=>{if(!t.length)return"Stable";const s=t[0],r=t[t.length-1]-s,n=.02;return r>n?"Improving":r<-n?"Declining":"Stable"},pe=(t,s=120,a=32)=>{if(!t.length)return"";const r=Math.min(...t),l=Math.max(...t)-r||1,d=t.length>1?s/(t.length-1):0;return t.map((o,x)=>{const m=d*x,g=(o-r)/l,f=a-g*a;return`${m},${f}`}).join(" ")},fe=({series:t})=>{if(!!!(t&&t.points&&t.points.length>0))return e.jsx(u,{title:"Health trend",children:e.jsx("p",{className:"text-sm text-gray-600",children:"Not enough data is available yet to show a trend for this index and date range."})});const a=t.points.map(m=>m.value),r=t.points.map(m=>m.date),n=Math.min(...a),l=Math.max(...a),d=ue(a),c=pe(a),o=r[0],x=r[r.length-1];return e.jsx(u,{title:"Health trend",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"text-xs uppercase tracking-wide text-gray-500",children:[t.indexType," over time"]}),e.jsxs("span",{className:"text-xs text-gray-500",children:[o," â€“ ",x]})]}),e.jsx("span",{className:"inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text[11px] font-medium text-gray-700",children:d})]}),e.jsx("div",{"aria-hidden":"true",children:e.jsx("svg",{viewBox:"0 0 120 32",role:"presentation",className:"h-8 w-full text-status-excellent",children:e.jsx("polyline",{fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",points:c})})}),e.jsxs("dl",{className:"mt-1 grid grid-cols-2 gap-2 text-xs text-gray-700",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"font-medium text-gray-900",children:"Min"}),e.jsx("dd",{children:n.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"font-medium text-gray-900",children:"Max"}),e.jsx("dd",{children:l.toFixed(2)})]})]})]})})},je=({active:t,payload:s,label:a})=>{if(!t||!s||!s.length)return null;const r=s[0],n=r.value,l=ye(n);return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg shadow-lg p-3",children:[e.jsx("p",{className:"text-xs font-medium text-gray-900 mb-1",children:a}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:r.stroke}}),e.jsx("p",{className:"text-sm font-semibold",style:{color:r.stroke},children:n.toFixed(3)}),e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${l==="excellent"?"bg-green-100 text-green-800":l==="good"?"bg-blue-100 text-blue-800":l==="fair"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:l})]})]})},ye=t=>t>=.7?"excellent":t>=.6?"good":t>=.4?"fair":"poor",D=t=>t>=.7?"#059669":t>=.6?"#10B981":t>=.4?"#F59E0B":"#EF4444",be=({series:t,title:s="Health Index Trend",height:a=300})=>{if(!t||!t.points||t.points.length===0)return e.jsx(u,{title:s,children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-4xl mb-2",children:"ðŸ“ˆ"}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"No trend data available"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Health data will appear here once satellite imagery is analyzed"})]})});const r=t.points.map(g=>({date:new Date(g.date).toLocaleDateString("en-US",{month:"short",day:"numeric"}),value:g.value,color:D(g.value)})),n=t.points.map(g=>g.value),l=n.reduce((g,f)=>g+f,0)/n.length,d=Math.min(...n),c=Math.max(...n),o=n[n.length-1],x=n.length>1?(o-n[0])/n[0]*100:0,m=D(l);return e.jsxs(u,{title:s,children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 mb-4 pb-4 border-b",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Latest"}),e.jsx("p",{className:"text-lg font-semibold",style:{color:D(o)},children:o.toFixed(3)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Average"}),e.jsx("p",{className:"text-lg font-semibold",style:{color:m},children:l.toFixed(3)})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Min / Max"}),e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:[d.toFixed(3)," / ",c.toFixed(3)]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Trend"}),e.jsxs("p",{className:`text-lg font-semibold ${x>0?"text-green-600":x<0?"text-red-600":"text-gray-600"}`,children:[x>0?"â†‘":x<0?"â†“":"â†’"," ",Math.abs(x).toFixed(1),"%"]})]})]}),e.jsx("div",{style:{width:"100%",height:a},children:e.jsx(Z,{children:e.jsxs(ee,{data:r,margin:{top:5,right:10,left:0,bottom:5},children:[e.jsx(te,{strokeDasharray:"3 3",stroke:"#E5E7EB"}),e.jsx(ae,{dataKey:"date",tick:{fontSize:12,fill:"#6B7280"},tickLine:{stroke:"#E5E7EB"}}),e.jsx(se,{domain:[0,1],tick:{fontSize:12,fill:"#6B7280"},tickLine:{stroke:"#E5E7EB"},label:{value:t.indexType.toUpperCase(),angle:-90,position:"insideLeft",style:{fontSize:12,fill:"#6B7280"}}}),e.jsx(re,{content:e.jsx(je,{})}),e.jsx(ne,{verticalAlign:"top",height:36,content:()=>e.jsxs("div",{className:"flex justify-center gap-4 text-xs mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-green-600"}),e.jsx("span",{children:"Excellent (â‰¥0.7)"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-blue-600"}),e.jsx("span",{children:"Good (0.6-0.7)"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-yellow-600"}),e.jsx("span",{children:"Fair (0.4-0.6)"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-600"}),e.jsx("span",{children:"Poor (<0.4)"})]})]})}),e.jsx(w,{y:.7,stroke:"#059669",strokeDasharray:"3 3"}),e.jsx(w,{y:.6,stroke:"#10B981",strokeDasharray:"3 3"}),e.jsx(w,{y:.4,stroke:"#F59E0B",strokeDasharray:"3 3"}),e.jsx(le,{type:"monotone",dataKey:"value",stroke:"#3B82F6",strokeWidth:3,dot:{r:4,fill:"#3B82F6",strokeWidth:2,stroke:"#fff"},activeDot:{r:6,strokeWidth:2}})]})})}),e.jsx("div",{className:"mt-4 pt-4 border-t",children:e.jsxs("p",{className:"text-xs text-gray-500",children:["ðŸ’¡ ",e.jsx("strong",{children:"Tip:"})," Higher values indicate healthier vegetation. Monitor trends to catch issues early."]})})]})},Ne=(t,s)=>v(void 0,null,function*(){try{return(yield M.get(`/fields/${t}/health`,{params:{startDate:s.startDate,endDate:s.endDate,indexType:s.indexType}})).data.data}catch(a){throw A(a)}}),ve=()=>v(void 0,null,function*(){try{return(yield M.get("/health/indices")).data.data}catch(t){throw A(t)}}),we=(t,s)=>$({queryKey:V.field(t,s),queryFn:()=>Ne(t,s),enabled:!!t&&!!s.startDate&&!!s.endDate}),De=()=>$({queryKey:V.indices,queryFn:()=>ve(),staleTime:60*60*1e3}),Fe=t=>{if(!t||t.length===0)return null;let s=t[0];for(const a of t)a.percentageArea>s.percentageArea&&(s=a);return s.label},ke=(t,s)=>{const a=new Date(t);return a.setDate(a.getDate()-s),a},L=t=>t.toISOString().split("T")[0],He=t=>{const s=new Date;let a;switch(t){case"7d":a=7;break;case"14d":a=14;break;case"30d":a=30;break;case"season":a=90;break;default:a=30}const r=ke(s,a);return{startDate:L(r),endDate:L(s)}},Se=(t,s)=>{if(!t||!t.timeSeries||t.timeSeries.length===0)return null;const a=t.timeSeries.find(r=>r.indexType===s);return a!=null?a:t.timeSeries[0]},B=()=>{var S,C,I;const{fieldId:t}=Q(),{showToast:s}=q(),{state:{currentFieldId:a,defaultHealthIndex:r,defaultHealthRange:n},setCurrentField:l,setHealthIndex:d,setHealthRange:c}=K(),{isOnline:o}=_(),x=(S=t!=null?t:a)!=null?S:"";p.useEffect(()=>{t&&l(t)},[t,l]);const{data:m,isLoading:g,isError:f}=J(x),{startDate:j,endDate:y}=p.useMemo(()=>He(n),[n]),P=p.useMemo(()=>({startDate:j,endDate:y,indexType:r}),[j,y,r]),{data:i,isLoading:F,isError:k,error:b,refetch:R,isFetching:z}=we(x,P);De();const h=p.useMemo(()=>Se(i,r),[i,r]),W=p.useMemo(()=>Fe(i==null?void 0:i.summary),[i]),O=p.useMemo(()=>{var N;if(typeof(i==null?void 0:i.latestIndex)=="number")return i.latestIndex;if(!(!h||!h.points.length))return(N=h.points[h.points.length-1])==null?void 0:N.value},[i,h]),G=p.useMemo(()=>!h||!h.points.length?void 0:h.points[h.points.length-1].date,[h]),H=!!(i!=null&&i.summary&&i.summary.length>0)||!!(h&&h.points.length>0),U=()=>{R(),s({title:"Retrying health data",description:"Attempting to reload field health metrics.",variant:"default"})};return t?e.jsxs("section",{"aria-labelledby":"field-health-heading",className:"space-y-4",children:[e.jsxs("header",{className:"space-y-1",children:[e.jsx("h1",{id:"field-health-heading",className:"text-lg font-semibold text-gray-900",children:"Field health"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Health overview for the selected field, summarizing vegetation indices, area breakdown, and recent trends."}),e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-3 text-xs text-gray-500",children:[m&&!g&&!f&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"font-medium text-gray-700",children:m.name}),e.jsxs("span",{children:["Area: ",m.areaHa.toFixed(2)," ha"]})]}),e.jsxs("span",{children:["Range: ",j," â€“ ",y]}),z&&e.jsx("span",{children:"Refreshingâ€¦"})]})]}),!o&&e.jsxs("p",{className:"flex items-center gap-2 text-xs text-amber-700",children:[e.jsx("span",{className:"inline-block h-2 w-2 rounded-full bg-amber-500","aria-hidden":"true"}),i?"You are offline. Showing the last loaded health data.":"You are offline and have no cached health data yet."]}),e.jsx(ie,{indexType:r,onIndexChange:d,range:n,onRangeChange:c}),F&&!i&&e.jsx(Y,{message:"Loading health data for this fieldâ€¦"}),k&&e.jsx(X,{title:"Unable to load health data",message:(C=b==null?void 0:b.message)!=null?C:"Something went wrong while loading health metrics for this field.",onRetry:U}),!F&&!k&&!H&&e.jsx(u,{title:"No health data available",children:e.jsx("p",{className:"text-sm text-gray-700",children:"There is no health data available for this field and date range yet. Try expanding the date range or check back after the next satellite pass."})}),H&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(me,{statusLabel:W,latestIndex:O,lastUpdated:G}),e.jsx(u,{title:"Area by health status",children:e.jsx(ge,{buckets:(I=i==null?void 0:i.summary)!=null?I:[]})}),e.jsx(be,{series:h,title:`${r.toUpperCase()} Trend (${n})`}),e.jsx(fe,{series:h}),e.jsx(ce,{indexType:r})]})]}):e.jsx("section",{"aria-labelledby":"field-health-heading",className:"space-y-4",children:e.jsxs("header",{className:"space-y-1",children:[e.jsx("h1",{id:"field-health-heading",className:"text-lg font-semibold text-gray-900",children:"Field not found"}),e.jsx("p",{className:"text-sm text-gray-600",children:"The requested field could not be identified from the URL. Please return to your fields list and try again."})]})})},Be=Object.freeze(Object.defineProperty({__proto__:null,FieldHealthPage:B,default:B},Symbol.toStringTag,{value:"Module"}));export{Be as F,Ne as g};
