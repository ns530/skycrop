var S=(t,s,a)=>new Promise((l,n)=>{var d=o=>{try{i(a.next(o))}catch(m){n(m)}},r=o=>{try{i(a.throw(o))}catch(m){n(m)}},i=o=>o.done?l(o.value):Promise.resolve(o.value).then(d,r);i((a=a.apply(t,s)).next())});import{h as U,n as B,y as q,C as j,L as C,E as T,B as E}from"./shared-B32_tFWT.js";import{j as e}from"./feature-admin-Bw8S4RZv.js";import{r as Y,R as Z,f as J,C as ee,X as te,Y as se,T as ae,a as re,b as ie,B as ne,c as le}from"./chart-vendor-C7uCl44m.js";import{u as M,a as de,b as ce}from"./query-vendor-B8e9_Lvn.js";import{u as oe}from"./feature-fields-fUbMVOqT.js";import{b as xe}from"./router-vendor-D1DOKBjT.js";const me=t=>S(void 0,null,function*(){try{return(yield U.post("/ml/yield/predict",t)).data.data}catch(s){throw B(s)}}),V=t=>({id:t.yield_id,fieldId:t.field_id,harvestDate:t.harvest_date,predictedYieldKgPerHa:t.predicted_yield_per_ha,actualYieldKgPerHa:t.actual_yield_per_ha,totalYieldKg:t.total_yield_kg,accuracy:t.accuracy_mape,notes:t.notes,cropVariety:t.crop_variety,season:t.season,createdAt:t.created_at,updatedAt:t.updated_at}),he=t=>S(void 0,null,function*(){const s=[{field_id:t,yield_kg_per_ha:4500,confidence_lower:4200,confidence_upper:4800},{field_id:t,yield_kg_per_ha:4800,confidence_lower:4500,confidence_upper:5100},{field_id:t,yield_kg_per_ha:4600,confidence_lower:4300,confidence_upper:4900},{field_id:t,yield_kg_per_ha:4900,confidence_lower:4600,confidence_upper:5200},{field_id:t,yield_kg_per_ha:4700,confidence_lower:4400,confidence_upper:5e3}];return yield new Promise(a=>setTimeout(a,500)),s}),ge=t=>S(void 0,null,function*(){try{return(yield U.get(`/fields/${t}/yield`,{params:{page:1,page_size:100,sort:"harvest_date",order:"desc"}})).data.data.map(V)}catch(s){throw B(s)}}),ue=t=>S(void 0,null,function*(){try{const s={actual_yield_per_ha:t.actualYieldKgPerHa,total_yield_kg:t.totalYieldKg||0,harvest_date:t.harvestDate,notes:t.notes,crop_variety:t.cropVariety,season:t.season,prediction_id:t.predictionId,predicted_yield_per_ha:t.predictedYieldKgPerHa},a=yield U.post(`/fields/${t.fieldId}/yield`,s);return V(a.data.data)}catch(s){throw B(s)}}),R=t=>{var s,a;return M({queryKey:q.forecast(t),queryFn:()=>me(t),enabled:!!((s=t.features)!=null&&s.length||(a=t.rows)!=null&&a.length),staleTime:10*60*1e3,gcTime:60*60*1e3})},G=t=>M({queryKey:q.history(t),queryFn:()=>he(t),enabled:!!t,staleTime:30*60*1e3,gcTime:60*60*1e3}),pe=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t),P=t=>new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:1}).format(t),ye=({request:t,fieldArea:s=1,pricePerKg:a=.5,className:l})=>{var p,x,N;const{data:n,isLoading:d,error:r}=R(t);if(d)return e.jsx(j,{title:"Yield Forecast",className:l,children:e.jsx(C,{message:"Calculating yield forecast..."})});if(r)return e.jsx(j,{title:"Yield Forecast",className:l,children:e.jsx(T,{title:"Failed to load yield forecast",message:"Unable to calculate yield prediction. Please try again."})});if(!((p=n==null?void 0:n.predictions)!=null&&p.length))return e.jsx(j,{title:"Yield Forecast",className:l,children:e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No yield predictions available"})});const i=n.predictions[0],o=i.yield_kg_per_ha,m=o*s,f=m*a,h=(x=i.confidence_lower)!=null?x:o*.9,y=(N=i.confidence_upper)!=null?N:o*1.1,u=y-h;return e.jsx(j,{title:"Yield Forecast",className:l,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-3xl font-bold text-gray-900",children:[P(o),e.jsx("span",{className:"text-lg font-normal text-gray-500 ml-1",children:"kg/ha"})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Predicted yield per hectare"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Confidence range:"}),e.jsxs("span",{className:"font-medium text-gray-900",children:["Â±",P(u/2)," kg/ha"]})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:[P(h)," - ",P(y)," kg/ha"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-lg font-semibold text-gray-900",children:[P(m)," kg"]}),e.jsx("p",{className:"text-xs text-gray-600",children:"Total yield"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-green-600",children:pe(f)}),e.jsx("p",{className:"text-xs text-gray-600",children:"Expected revenue"})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 text-center border-t pt-2",children:["Based on ",P(s)," ha field area at $",a,"/kg"]})]})})},H=t=>new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}).format(t),fe=({fieldId:t,className:s})=>{const{data:a,isLoading:l,error:n}=G(t);if(l)return e.jsx(j,{title:"Yield History",className:s,children:e.jsx(C,{message:"Loading yield history..."})});if(n)return e.jsx(j,{title:"Yield History",className:s,children:e.jsx(T,{title:"Failed to load yield history",message:"Unable to retrieve historical yield data."})});if(!(a!=null&&a.length))return e.jsx(j,{title:"Yield History",className:s,children:e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No historical yield data available"})});const d=400,r=200,i=40,o=d-i*2,m=r-i*2,f=a.map(g=>g.yield_kg_per_ha),h=Math.min(...f),y=Math.max(...f),u=y-h||1,p=g=>i+g/(a.length-1)*o,x=g=>r-i-(g-h)/u*m,N=a.map((g,b)=>`${b===0?"M":"L"} ${p(b)} ${x(g.yield_kg_per_ha)}`).join(" "),F=a.flatMap((g,b)=>{var v,_;const D=(v=g.confidence_lower)!=null?v:g.yield_kg_per_ha*.9,w=(_=g.confidence_upper)!=null?_:g.yield_kg_per_ha*1.1,k=p(b),$=x(D),c=x(w);return b===0?[`M ${k} ${c}`,`L ${k} ${$}`]:b===a.length-1?[`L ${k} ${c}`,`L ${k} ${$}`,"Z"]:[`L ${k} ${c}`,`L ${k} ${$}`]}).join(" ");return e.jsx(j,{title:"Yield History & Predictions",className:s,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("svg",{width:d,height:r,className:"w-full h-auto",children:[e.jsx("defs",{children:e.jsx("pattern",{id:"grid",width:"40",height:"20",patternUnits:"userSpaceOnUse",children:e.jsx("path",{d:"M 40 0 L 0 0 0 20",fill:"none",stroke:"#f3f4f6",strokeWidth:"1"})})}),e.jsx("rect",{width:"100%",height:"100%",fill:"url(#grid)"}),e.jsx("path",{d:F,fill:"rgba(59, 130, 246, 0.1)",stroke:"none"}),e.jsx("line",{x1:i,y1:i,x2:i,y2:r-i,stroke:"#6b7280",strokeWidth:"1"}),e.jsx("line",{x1:i,y1:r-i,x2:d-i,y2:r-i,stroke:"#6b7280",strokeWidth:"1"}),e.jsx("path",{d:N,fill:"none",stroke:"#3b82f6",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),a.map((g,b)=>e.jsx("circle",{cx:p(b),cy:x(g.yield_kg_per_ha),r:"4",fill:"#3b82f6",stroke:"#ffffff",strokeWidth:"2"},b)),e.jsx("text",{x:i-10,y:i+5,textAnchor:"end",className:"text-xs fill-gray-600",children:H(y)}),e.jsx("text",{x:i-10,y:r-i+5,textAnchor:"end",className:"text-xs fill-gray-600",children:H(h)}),e.jsx("text",{x:i,y:r-i+20,textAnchor:"middle",className:"text-xs fill-gray-600",children:"Past"}),e.jsx("text",{x:d-i,y:r-i+20,textAnchor:"middle",className:"text-xs fill-gray-600",children:"Future"})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-6 text-sm",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded-full"}),e.jsx("span",{className:"text-gray-600",children:"Predicted Yield"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-100 rounded"}),e.jsx("span",{className:"text-gray-600",children:"Confidence Range"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center text-sm",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold text-gray-900",children:[H(Math.max(...f))," kg/ha"]}),e.jsx("div",{className:"text-gray-600",children:"Peak"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold text-gray-900",children:[H(f.reduce((g,b)=>g+b,0)/f.length)," kg/ha"]}),e.jsx("div",{className:"text-gray-600",children:"Average"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-900",children:a.length}),e.jsx("div",{className:"text-gray-600",children:"Data points"})]})]})]})})},I={critical:3,warning:2,info:1},je=t=>{switch(t){case"critical":return{container:"border-red-300 bg-red-50 text-red-900",icon:"text-red-600"};case"warning":return{container:"border-amber-300 bg-amber-50 text-amber-900",icon:"text-amber-600"};case"info":default:return{container:"border-sky-300 bg-sky-50 text-sky-900",icon:"text-sky-600"}}},Ne=t=>{switch(t){case"critical":return"Critical yield alert";case"warning":return"Yield warning";case"info":default:return"Yield information"}},be=({alerts:t})=>{if(!t||t.length===0)return null;const a=[...t].sort((r,i)=>{var o,m;return((o=I[i.severity])!=null?o:0)-((m=I[r.severity])!=null?m:0)})[0],l=t.length-1,{container:n,icon:d}=je(a.severity);return e.jsxs("section",{className:`flex items-start gap-3 rounded-lg border px-3 py-2 text-xs sm:text-sm ${n}`,role:"alert","aria-live":"assertive",children:[e.jsx("div",{className:"mt-0.5 shrink-0",children:e.jsx("span",{className:`text-base sm:text-lg ${d}`,"aria-hidden":"true",children:"âš "})}),e.jsxs("div",{className:"flex-1 space-y-0.5",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide",children:Ne(a.severity)}),e.jsx("p",{className:"font-medium",children:a.title}),a.description&&e.jsx("p",{className:"text-[11px] sm:text-xs opacity-90 line-clamp-3",children:a.description}),(a.threshold!==void 0||a.predicted!==void 0)&&e.jsxs("p",{className:"text-[11px] sm:text-xs opacity-80",children:[a.predicted!==void 0&&`Predicted: ${a.predicted.toLocaleString()} kg/ha`,a.threshold!==void 0&&a.predicted!==void 0&&" | ",a.threshold!==void 0&&`Threshold: ${a.threshold.toLocaleString()} kg/ha`]})]}),l>0&&e.jsx("div",{className:"ml-2 shrink-0",children:e.jsxs("span",{className:"inline-flex items-center rounded-full bg-white/40 px-2 py-0.5 text-[10px] font-medium text-current",children:["+",l," more alerts"]})})]})},A=t=>new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:1}).format(t),ve=({currentYield:t,previousYield:s})=>{const a=t-s,l=a/s*100,n=a>0;return e.jsxs("div",{className:"bg-blue-50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"vs Previous Season"}),e.jsxs("span",{className:`font-medium ${n?"text-green-600":"text-red-600"}`,children:[n?"+":"",A(l),"%"]})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:["Current: ",A(t)," kg/ha â€¢ Previous: ",A(s)," kg/ha"]})]})},K=t=>new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:1}).format(t),_e=({confidenceLower:t,confidenceUpper:s})=>{const a=s-t;return e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"95% Confidence interval:"}),e.jsxs("span",{className:"font-medium text-gray-900",children:["Â±",K(a/2)," kg/ha"]})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:[K(t)," - ",K(s)," kg/ha"]})]})},we=({harvestDate:t})=>{const s=n=>{const d=new Date(n);return new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric"}).format(d)},l=(()=>{const n=new Date,r=new Date(t).getTime()-n.getTime();return Math.ceil(r/864e5)})();return e.jsxs("div",{className:"bg-green-50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Estimated Harvest Date"}),e.jsx("span",{className:"font-medium text-gray-900",children:l>0?`${l} days`:"Ready"})]}),e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:s(t)})]})},L=t=>new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:1}).format(t),Fe=({currentYield:t,optimalYield:s})=>{const a=Math.min(t/s*100,100),l=t>=s;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Progress vs Optimal Yield"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[L(a),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full transition-all duration-300 ${l?"bg-green-500":"bg-blue-500"}`,style:{width:`${a}%`}})}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsxs("span",{children:["Current: ",L(t)," kg/ha"]}),e.jsxs("span",{children:["Optimal: ",L(s)," kg/ha"]})]})]})},ke=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t),W=t=>new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:1}).format(t),Ye=t=>{const s=new Date(t);return new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric"}).format(s)},De=({yieldKgHa:t,totalYield:s,revenue:a,harvestDate:l})=>{const n=()=>{const d=`ðŸŒ¾ My field yield forecast:

â€¢ Predicted yield: ${W(t)} kg/ha
â€¢ Total yield: ${W(s)} kg
â€¢ Expected revenue: ${ke(a)}
â€¢ Harvest date: ${Ye(l)}

Powered by SkyCrop`,i=`https://wa.me/?text=${encodeURIComponent(d)}`;window.open(i,"_blank")};return e.jsx("div",{className:"flex justify-center",children:e.jsx(E,{size:"sm",variant:"secondary",onClick:n,className:"bg-green-600 hover:bg-green-700 text-white",children:"ðŸ“± Share on WhatsApp"})})},Se=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t),O=t=>new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:1}).format(t),Pe=({yieldKgHa:t,totalYield:s,revenue:a,pricePerKg:l})=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-3xl font-bold text-gray-900",children:[O(t),e.jsx("span",{className:"text-lg font-normal text-gray-500 ml-1",children:"kg/ha"})]}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Predicted yield per hectare"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-lg font-semibold text-gray-900",children:[O(s)," kg"]}),e.jsx("p",{className:"text-xs text-gray-600",children:"Total yield"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-green-600",children:Se(a)}),e.jsx("p",{className:"text-xs text-gray-600",children:"Expected revenue"})]})]})]}),$e=t=>new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:1}).format(t),He=({request:t,fieldArea:s=1,pricePerKg:a=.5,className:l})=>{var N,F,g,b,D,w;const{data:n,isLoading:d,error:r}=R(t);if(d)return e.jsx(j,{title:"Yield Forecast",className:l,children:e.jsx(C,{message:"Calculating yield forecast..."})});if(r)return e.jsx(j,{title:"Yield Forecast",className:l,children:e.jsx(T,{title:"Failed to load yield forecast",message:"Unable to calculate yield prediction. Please try again."})});if(!((N=n==null?void 0:n.predictions)!=null&&N.length))return e.jsx(j,{title:"Yield Forecast",className:l,children:e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No yield predictions available"})});const i=n.predictions[0],o=i.yield_kg_per_ha,m=o*s,f=m*a,h=(F=i.confidence_lower)!=null?F:o*.9,y=(g=i.confidence_upper)!=null?g:o*1.1,u=(b=i.optimal_yield)!=null?b:5500,p=(D=i.previous_season_yield)!=null?D:4800,x=(w=i.harvest_date)!=null?w:"2025-03-15";return e.jsx(j,{title:"Yield Forecast",className:l,children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(Pe,{yieldKgHa:o,totalYield:m,revenue:f,pricePerKg:a}),e.jsx(_e,{confidenceLower:h,confidenceUpper:y}),e.jsx(Fe,{currentYield:o,optimalYield:u}),e.jsx(ve,{currentYield:o,previousYield:p}),e.jsx(we,{harvestDate:x}),e.jsx(De,{yieldKgHa:o,totalYield:m,revenue:f,harvestDate:x}),e.jsxs("div",{className:"text-xs text-gray-500 text-center border-t pt-2",children:["Based on ",$e(s)," ha field area at $",a,"/kg"]})]})})},Me=({request:t,fieldArea:s=1,pricePerKg:a=.5,className:l})=>e.jsxs("div",{className:`space-y-4 ${l||""}`,children:[e.jsx("h2",{className:"text-md font-semibold text-gray-900",children:"Yield Forecast"}),e.jsx(He,{request:t,fieldArea:s,pricePerKg:a})]}),Re=({fieldId:t,fieldAreaHa:s,predictedYieldKgPerHa:a,onSubmit:l,onCancel:n,isSubmitting:d=!1})=>{const r=new Date().toISOString().split("T")[0],[i,o]=Y.useState(r),[m,f]=Y.useState("per_ha"),[h,y]=Y.useState(""),[u,p]=Y.useState(""),[x,N]=Y.useState(""),[F,g]=Y.useState({}),b=c=>{if(y(c),c&&!isNaN(parseFloat(c))){const v=parseFloat(c);p((v*s).toFixed(0))}},D=c=>{if(p(c),c&&!isNaN(parseFloat(c))){const v=parseFloat(c);y((v/s).toFixed(0))}},w=(()=>{if(!a||!h)return null;const c=parseFloat(h);if(isNaN(c))return null;const _=Math.abs(c-a)/c*100;return{difference:c-a,percentageError:_,isAccurate:_<15}})(),k=()=>{const c={};i||(c.harvestDate="Harvest date is required");const v=m==="per_ha"?h:u;if(!v||v.trim()==="")c.yield="Yield amount is required";else{const _=parseFloat(v);isNaN(_)||_<=0?c.yield="Yield must be a positive number":m==="per_ha"&&_>15e3?c.yield="Yield per hectare seems unusually high (>15,000 kg/ha)":m==="total"&&_>5e4&&(c.yield="Total yield seems unusually high")}return g(c),Object.keys(c).length===0},$=c=>S(void 0,null,function*(){if(c.preventDefault(),!k())return;const v=parseFloat(h),_=parseFloat(u),X={harvestDate:i,actualYieldKgPerHa:v,totalYieldKg:isNaN(_)?void 0:_,notes:x.trim()||void 0};yield l(X)});return e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"harvest-date",className:"block text-sm font-medium text-gray-900 mb-1",children:["Harvest Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{id:"harvest-date",type:"date",value:i,onChange:c=>o(c.target.value),max:r,className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-brand-blue focus:outline-none focus:ring-1 focus:ring-brand-blue"}),F.harvestDate&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:F.harvestDate})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-900 mb-2",children:["Enter yield as ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>f("per_ha"),className:`flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors ${m==="per_ha"?"bg-brand-blue text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Per Hectare (kg/ha)"}),e.jsx("button",{type:"button",onClick:()=>f("total"),className:`flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors ${m==="total"?"bg-brand-blue text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Total Yield (kg)"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"yield-input",className:"block text-sm font-medium text-gray-900 mb-1",children:[m==="per_ha"?"Yield per Hectare (kg/ha)":"Total Yield (kg)",e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),e.jsx("input",{id:"yield-input",type:"number",step:"0.1",value:m==="per_ha"?h:u,onChange:c=>m==="per_ha"?b(c.target.value):D(c.target.value),placeholder:m==="per_ha"?"e.g., 4500":"e.g., 11250",className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-brand-blue focus:outline-none focus:ring-1 focus:ring-brand-blue"}),F.yield&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:F.yield}),h&&u&&e.jsx("p",{className:"mt-1 text-xs text-gray-600",children:m==="per_ha"?e.jsxs(e.Fragment,{children:["â‰ˆ ",u," kg total for ",s.toFixed(2)," ha"]}):e.jsxs(e.Fragment,{children:["â‰ˆ ",h," kg/ha for ",s.toFixed(2)," ha"]})})]}),a&&w&&e.jsxs("div",{className:`rounded-lg border p-3 ${w.isAccurate?"bg-green-50 border-green-200":"bg-yellow-50 border-yellow-200"}`,children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 mb-1",children:"Prediction Comparison"}),e.jsxs("div",{className:"space-y-1 text-xs text-gray-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Predicted:"})," ",a.toFixed(0)," kg/ha"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Actual:"})," ",parseFloat(h).toFixed(0)," kg/ha"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Difference:"})," ",e.jsxs("span",{className:w.difference>=0?"text-green-700":"text-red-700",children:[w.difference>=0?"+":"",w.difference.toFixed(0)," kg/ha (",w.percentageError.toFixed(1),"% error)"]})]}),w.isAccurate?e.jsx("p",{className:"text-green-700 font-medium mt-2",children:"âœ“ Our prediction was accurate! This helps improve future predictions."}):e.jsx("p",{className:"text-yellow-700 font-medium mt-2",children:"âš  Significant difference. We'll use this data to improve future predictions."})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"yield-notes",className:"block text-sm font-medium text-gray-900 mb-1",children:"Notes (Optional)"}),e.jsx("textarea",{id:"yield-notes",value:x,onChange:c=>N(c.target.value),rows:3,placeholder:"e.g., Weather was favorable, good irrigation...",className:"w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-brand-blue focus:outline-none focus:ring-1 focus:ring-brand-blue resize-none"})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(E,{type:"submit",disabled:d,className:"flex-1",children:d?"Saving...":"Save Yield Data"}),n&&e.jsx(E,{type:"button",variant:"secondary",onClick:n,disabled:d,children:"Cancel"})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ðŸ’¡ ",e.jsx("strong",{children:"Tip:"})," Entering accurate yield data helps our AI improve predictions for your next season."]})]})},Ie=({records:t,isLoading:s,fieldAreaHa:a})=>{if(s)return e.jsx(j,{title:"Yield History",children:e.jsxs("div",{className:"animate-pulse space-y-3",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-2/3"})]})});if(t.length===0)return e.jsx(j,{title:"Yield History",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-4xl mb-2",children:"ðŸŒ¾"}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"No yield data recorded yet"}),e.jsx("p",{className:"text-xs text-gray-500",children:"After each harvest, record your actual yield to help improve predictions"})]})});const l=t.reduce((r,i)=>r+i.actualYieldKgPerHa,0)/t.length,n=t.filter(r=>r.predictedYieldKgPerHa).reduce((r,i)=>r+(i.predictedYieldKgPerHa||0),0)/t.filter(r=>r.predictedYieldKgPerHa).length,d=t.filter(r=>r.accuracy!==void 0).reduce((r,i)=>r+(i.accuracy||0),0)/t.filter(r=>r.accuracy!==void 0).length;return e.jsxs(j,{title:"Yield History",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4 pb-4 border-b",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Avg Actual"}),e.jsxs("p",{className:"text-lg font-semibold text-gray-900",children:[l.toFixed(0),e.jsx("span",{className:"text-xs font-normal text-gray-600 ml-1",children:"kg/ha"})]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Avg Predicted"}),e.jsxs("p",{className:"text-lg font-semibold text-gray-900",children:[isNaN(n)?"â€”":n.toFixed(0),e.jsx("span",{className:"text-xs font-normal text-gray-600 ml-1",children:!isNaN(n)&&"kg/ha"})]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Avg Accuracy"}),e.jsx("p",{className:`text-lg font-semibold ${!isNaN(d)&&d<15?"text-green-600":"text-yellow-600"}`,children:isNaN(d)?"â€”":`${(100-d).toFixed(0)}%`})]})]}),e.jsx("div",{className:"overflow-x-auto -mx-4 sm:mx-0",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b text-left",children:[e.jsx("th",{className:"py-2 px-2 font-medium text-gray-700",children:"Harvest Date"}),e.jsx("th",{className:"py-2 px-2 font-medium text-gray-700 text-right",children:"Predicted"}),e.jsx("th",{className:"py-2 px-2 font-medium text-gray-700 text-right",children:"Actual"}),e.jsx("th",{className:"py-2 px-2 font-medium text-gray-700 text-right",children:"Diff"}),e.jsx("th",{className:"py-2 px-2 font-medium text-gray-700",children:"Notes"})]})}),e.jsx("tbody",{children:t.map(r=>{const i=r.predictedYieldKgPerHa?r.actualYieldKgPerHa-r.predictedYieldKgPerHa:null;return e.jsxs("tr",{className:"border-b last:border-0 hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 px-2",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:new Date(r.harvestDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}),r.totalYieldKg&&e.jsxs("p",{className:"text-xs text-gray-500",children:[r.totalYieldKg.toFixed(0)," kg total"]})]})}),e.jsx("td",{className:"py-3 px-2 text-right",children:r.predictedYieldKgPerHa?e.jsxs("span",{className:"text-gray-700",children:[r.predictedYieldKgPerHa.toFixed(0),e.jsx("span",{className:"text-xs text-gray-500 ml-1",children:"kg/ha"})]}):e.jsx("span",{className:"text-gray-400",children:"â€”"})}),e.jsx("td",{className:"py-3 px-2 text-right",children:e.jsxs("span",{className:"font-medium text-gray-900",children:[r.actualYieldKgPerHa.toFixed(0),e.jsx("span",{className:"text-xs text-gray-600 font-normal ml-1",children:"kg/ha"})]})}),e.jsx("td",{className:"py-3 px-2 text-right",children:i!==null?e.jsxs("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${i>=0?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:[i>=0?"+":"",i.toFixed(0)]}):e.jsx("span",{className:"text-gray-400",children:"â€”"})}),e.jsx("td",{className:"py-3 px-2",children:r.notes?e.jsx("span",{className:"text-xs text-gray-600 line-clamp-2",children:r.notes}):e.jsx("span",{className:"text-gray-400 text-xs",children:"â€”"})})]},r.id)})})]})}),e.jsx("div",{className:"mt-4 pt-4 border-t",children:e.jsxs("p",{className:"text-xs text-gray-500",children:["ðŸ’¡ ",e.jsx("strong",{children:"Tip:"})," Green differences mean you harvested more than predicted. This data helps improve future predictions."]})})]})},Ce=({active:t,payload:s,label:a})=>{if(!t||!s||!s.length)return null;const l=s.find(d=>d.dataKey==="actual"),n=s.find(d=>d.dataKey==="predicted");return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg shadow-lg p-3",children:[e.jsx("p",{className:"text-xs font-medium text-gray-900 mb-2",children:a}),l&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-green-600"}),e.jsx("span",{className:"text-xs text-gray-600",children:"Actual:"}),e.jsxs("span",{className:"text-sm font-semibold text-green-700",children:[l.value.toFixed(0)," kg/ha"]})]}),n&&n.value&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-blue-600"}),e.jsx("span",{className:"text-xs text-gray-600",children:"Predicted:"}),e.jsxs("span",{className:"text-sm font-semibold text-blue-700",children:[n.value.toFixed(0)," kg/ha"]})]}),l&&n&&n.value&&e.jsx("div",{className:"mt-2 pt-2 border-t border-gray-200",children:e.jsxs("p",{className:"text-xs text-gray-600",children:["Difference:"," ",e.jsxs("span",{className:`font-medium ${l.value>n.value?"text-green-700":"text-red-700"}`,children:[l.value>n.value?"+":"",(l.value-n.value).toFixed(0)," kg/ha"]})]})})]})},We=({records:t,title:s="Yield History",height:a=350,showPredictions:l=!0})=>{if(!t||t.length===0)return e.jsx(j,{title:s,children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-4xl mb-2",children:"ðŸŒ¾"}),e.jsx("p",{className:"text-sm text-gray-600 mb-1",children:"No yield data recorded yet"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Record your harvest yields to see trends over time"})]})});const d=[...t].sort((x,N)=>new Date(x.harvestDate).getTime()-new Date(N.harvestDate).getTime()).map(x=>({date:new Date(x.harvestDate).toLocaleDateString("en-US",{month:"short",year:"2-digit"}),actual:x.actualYieldKgPerHa,predicted:x.predictedYieldKgPerHa||null,notes:x.notes})),r=t.map(x=>x.actualYieldKgPerHa),i=r.reduce((x,N)=>x+N,0)/r.length,o=Math.min(...r),m=Math.max(...r),f=r[r.length-1],h=r[0],y=r.length>1?(f-h)/h*100:0,u=t.filter(x=>x.predictedYieldKgPerHa),p=u.length>0?u.reduce((x,N)=>{const g=Math.abs(N.actualYieldKgPerHa-(N.predictedYieldKgPerHa||0))/N.actualYieldKgPerHa*100;return x+(100-g)},0)/u.length:null;return e.jsxs(j,{title:s,children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 mb-4 pb-4 border-b",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Latest"}),e.jsxs("p",{className:"text-lg font-semibold text-gray-900",children:[f.toFixed(0),e.jsx("span",{className:"text-xs font-normal text-gray-600 ml-1",children:"kg/ha"})]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Average"}),e.jsxs("p",{className:"text-lg font-semibold text-gray-900",children:[i.toFixed(0),e.jsx("span",{className:"text-xs font-normal text-gray-600 ml-1",children:"kg/ha"})]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Range"}),e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:[o.toFixed(0)," - ",m.toFixed(0)]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Growth"}),e.jsxs("p",{className:`text-lg font-semibold ${y>0?"text-green-600":y<0?"text-red-600":"text-gray-600"}`,children:[y>0?"â†‘":y<0?"â†“":"â†’"," ",Math.abs(y).toFixed(1),"%"]})]})]}),p!==null&&e.jsxs("div",{className:"mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3",children:[e.jsxs("p",{className:"text-sm font-medium text-blue-900 mb-1",children:["Prediction Accuracy: ",p.toFixed(1),"%"]}),e.jsxs("p",{className:"text-xs text-blue-700",children:["Based on ",u.length," harvest(s) with predictions"]})]}),e.jsx("div",{style:{width:"100%",height:a},children:e.jsx(Z,{children:e.jsxs(J,{data:d,margin:{top:5,right:20,left:0,bottom:5},children:[e.jsx(ee,{strokeDasharray:"3 3",stroke:"#E5E7EB"}),e.jsx(te,{dataKey:"date",tick:{fontSize:12,fill:"#6B7280"},tickLine:{stroke:"#E5E7EB"}}),e.jsx(se,{tick:{fontSize:12,fill:"#6B7280"},tickLine:{stroke:"#E5E7EB"},label:{value:"Yield (kg/ha)",angle:-90,position:"insideLeft",style:{fontSize:12,fill:"#6B7280"}}}),e.jsx(ae,{content:e.jsx(Ce,{})}),e.jsx(re,{verticalAlign:"top",height:36,content:()=>e.jsxs("div",{className:"flex justify-center gap-4 text-xs mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-4 h-3 rounded bg-green-600"}),e.jsx("span",{children:"Actual Yield"})]}),l&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-8 h-0.5 bg-blue-600"}),e.jsx("span",{children:"Predicted Yield"})]})]})}),e.jsx(ie,{y:i,stroke:"#9CA3AF",strokeDasharray:"3 3",label:{value:`Avg: ${i.toFixed(0)}`,fontSize:10,fill:"#6B7280",position:"right"}}),e.jsx(ne,{dataKey:"actual",fill:"#10B981",radius:[4,4,0,0]}),l&&e.jsx(le,{type:"monotone",dataKey:"predicted",stroke:"#3B82F6",strokeWidth:2,dot:{r:4,fill:"#3B82F6",strokeWidth:2,stroke:"#fff"},connectNulls:!1})]})})}),e.jsx("div",{className:"mt-4 pt-4 border-t",children:e.jsxs("p",{className:"text-xs text-gray-500",children:["ðŸ’¡ ",e.jsx("strong",{children:"Tip:"})," Track your yields over time to identify patterns and improve farming practices.",p!==null&&p>85&&" Your predictions are highly accurate!"]})})]})},Q={all:["yield"],records:t=>["yield","records",t],predictions:t=>["yield","predictions",t]},Oe=t=>M({queryKey:Q.records(t),queryFn:()=>ge(t),enabled:!!t,staleTime:5*60*1e3}),ze=()=>{const t=de();return ce({mutationFn:ue,onSuccess:s=>{t.invalidateQueries({queryKey:Q.records(s.fieldId)})}})},z=()=>{const{fieldId:t}=xe(),{data:s,isLoading:a,isError:l}=oe(t!=null?t:""),n=Y.useMemo(()=>t?{features:[{field_id:t,ndvi:.7,ndwi:.2,temperature:25,rainfall:150}]}:null,[t]),{data:d,isLoading:r,isError:i}=R(n!=null?n:{}),{data:o,isLoading:m}=G(t!=null?t:""),f=Y.useMemo(()=>{var x;if(!((x=d==null?void 0:d.predictions)!=null&&x.length))return[];const u=d.predictions[0],p=[];return u.yield_kg_per_ha<4e3&&p.push({id:"low-yield-warning",title:"Low yield prediction detected",description:"The predicted yield is below the typical threshold. Consider reviewing irrigation and fertilization practices.",severity:"warning",fieldId:t,predicted:u.yield_kg_per_ha,threshold:4e3}),u.yield_kg_per_ha<3e3&&p.push({id:"critical-yield-alert",title:"Critical yield prediction",description:"Yield prediction indicates potential crop failure. Immediate intervention recommended.",severity:"critical",fieldId:t,predicted:u.yield_kg_per_ha,threshold:3e3}),p},[d,t]);if(!t)return e.jsx("section",{"aria-labelledby":"field-yield-heading",className:"space-y-4",children:e.jsxs("header",{className:"space-y-1",children:[e.jsx("h1",{id:"field-yield-heading",className:"text-lg font-semibold text-gray-900",children:"Field not found"}),e.jsx("p",{className:"text-sm text-gray-600",children:"The requested field could not be identified from the URL. Please return to your fields list and try again."})]})});const h=a||r||m,y=l||i;return e.jsxs("section",{"aria-labelledby":"field-yield-heading",className:"space-y-4",children:[e.jsxs("header",{className:"space-y-1",children:[e.jsx("h1",{id:"field-yield-heading",className:"text-lg font-semibold text-gray-900",children:"Yield predictions"}),e.jsx("p",{className:"text-sm text-gray-600",children:"AI-powered yield forecasting and historical analysis for optimal harvest planning."}),e.jsx("div",{className:"mt-2 flex flex-wrap items-center gap-3 text-xs text-gray-500",children:s&&!a&&!l&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"font-medium text-gray-700",children:s.name}),e.jsxs("span",{children:["Area: ",s.areaHa.toFixed(2)," ha"]})]})})]}),e.jsx(be,{alerts:f}),h&&!d&&!o&&e.jsx(C,{message:"Loading yield data..."}),y&&e.jsx(T,{title:"Unable to load yield data",message:"Something went wrong while loading yield predictions and history."}),!h&&!y&&e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsx("div",{className:"lg:col-span-1",children:n&&e.jsx(ye,{request:n,fieldArea:s==null?void 0:s.areaHa,pricePerKg:.5})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(fe,{fieldId:t})})]}),e.jsx(j,{title:"About yield predictions",children:e.jsxs("div",{className:"space-y-2 text-sm text-gray-700",children:[e.jsx("p",{children:"Yield predictions are generated using machine learning models trained on satellite imagery, weather data, and historical yield records. Predictions include confidence intervals to help with decision making."}),e.jsxs("p",{children:[e.jsx("strong",{children:"Note:"})," These predictions are estimates and actual yields may vary due to unforeseen factors such as weather events, pest infestations, or changes in farming practices."]})]})})]})},qe=Object.freeze(Object.defineProperty({__proto__:null,FieldYieldPage:z,default:z},Symbol.toStringTag,{value:"Module"}));export{qe as F,Me as Y,ze as a,Re as b,We as c,Ie as d,me as g,Oe as u};
