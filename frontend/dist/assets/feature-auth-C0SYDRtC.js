var m=(t,s,a)=>new Promise((u,l)=>{var o=d=>{try{c(a.next(d))}catch(h){l(h)}},p=d=>{try{c(a.throw(d))}catch(h){l(h)}},c=d=>d.done?u(d.value):Promise.resolve(d.value).then(o,p);c((a=a.apply(t,s)).next())});import{j as e}from"./feature-admin-Bw8S4RZv.js";import{u as T,N as V,a as F,L as I}from"./router-vendor-D1DOKBjT.js";import{r as n}from"./chart-vendor-C7uCl44m.js";import{h as _,n as R,A as J,u as A,s as E,c as Y,C as L,B as P}from"./shared-B32_tFWT.js";const $=t=>{var s;return{accessToken:t.token,refreshToken:(s=t.refreshToken)!=null?s:null}},B=t=>m(void 0,null,function*(){try{return(yield _.post("/auth/signup",t)).data.data}catch(s){throw R(s)}}),H=t=>m(void 0,null,function*(){try{return(yield _.post("/auth/login",t)).data.data}catch(s){throw R(s)}}),K=()=>m(void 0,null,function*(){try{yield _.post("/auth/logout")}catch(t){const s=R(t);s instanceof J&&console.warn("Logout failed (best-effort only):",s.message)}}),Q=t=>m(void 0,null,function*(){try{yield _.post("/auth/request-password-reset",{email:t})}catch(s){throw R(s)}}),X=t=>m(void 0,null,function*(){try{yield _.post("/auth/reset-password",t)}catch(s){throw R(s)}}),Z=t=>m(void 0,null,function*(){return null}),D=n.createContext(void 0),O="skycrop_auth_session",ee="skycrop_post_login_redirect",se=t=>({id:t.user.user_id,email:t.user.email,name:t.user.name,role:t.user.role,emailVerified:t.user.email_verified}),te=t=>{try{const s=t.split(".");if(s.length<2)throw new Error("Invalid token format");const a=s[1].replace(/-/g,"+").replace(/_/g,"/"),u=a.padEnd(a.length+(4-a.length%4)%4,"="),l=atob(u);return JSON.parse(l)}catch(s){return console.error("Failed to decode JWT payload",s),{}}},le=({children:t})=>{const[s,a]=n.useState(null),[u,l]=n.useState("loading"),{showToast:o}=A(),p=n.useCallback(r=>{var C,q;const i=se(r),w=$(r);a(i),E({accessToken:w.accessToken,refreshToken:(C=w.refreshToken)!=null?C:null}),window.localStorage.setItem(O,JSON.stringify({user:i,accessToken:w.accessToken,refreshToken:(q=w.refreshToken)!=null?q:null})),l("authenticated")},[]),c=n.useCallback(()=>{a(null),E({accessToken:null,refreshToken:null}),window.localStorage.removeItem(O),l("unauthenticated")},[]),d=n.useCallback(r=>m(void 0,null,function*(){const{callApi:i=!0}=r||{};try{i&&(yield K())}catch(w){}finally{c()}}),[c]);n.useEffect(()=>{Y({refreshFn:Z,onAuthError:()=>{d({callApi:!1})}})},[d]),n.useEffect(()=>{var r;try{const i=window.localStorage.getItem(O);if(!i){l("unauthenticated");return}const w=JSON.parse(i);if(!w.user||!w.accessToken){l("unauthenticated");return}a(w.user),E({accessToken:w.accessToken,refreshToken:(r=w.refreshToken)!=null?r:null}),l("authenticated")}catch(i){l("unauthenticated")}},[]);const h=n.useCallback(r=>m(void 0,null,function*(){const i=yield H(r);p(i)}),[p]),g=n.useCallback(r=>m(void 0,null,function*(){const i=yield B(r);p(i),o({variant:"success",title:"Account created",description:"Your SkyCrop account is ready. You are now signed in."})}),[p,o]),v=n.useCallback(r=>m(void 0,null,function*(){yield Q(r),o({variant:"success",title:"Check your inbox",description:"If an account exists for this email, a reset link has been sent."})}),[o]),f=n.useCallback((r,i)=>m(void 0,null,function*(){yield X({token:r,newPassword:i}),o({variant:"success",title:"Password updated",description:"You can now sign in with your new password."})}),[o]),k=n.useCallback(r=>{r&&window.sessionStorage.setItem(ee,r),window.location.href="/api/v1/auth/google"},[]),b=n.useCallback(r=>m(void 0,null,function*(){const i=te(r);if(!i.user_id||!i.email||!i.role)throw new Error("Invalid token returned from Google sign-in");const w=i.email.split("@")[0]||"Google user",C={id:i.user_id,email:i.email,name:w,role:i.role,emailVerified:!0};a(C),E({accessToken:r,refreshToken:null}),window.localStorage.setItem(O,JSON.stringify({user:C,accessToken:r,refreshToken:null})),l("authenticated")}),[]),j=n.useCallback(r=>{a(r),l("authenticated")},[]),N=n.useCallback(()=>{d({callApi:!0})},[d]),y=n.useCallback(r=>s?s.role===r:!1,[s]),x=n.useMemo(()=>({user:s,status:u,login:j,logout:N,hasRole:y,loginWithEmail:h,registerWithEmail:g,requestPasswordReset:v,resetPassword:f,startGoogleOAuth:k,completeOAuthLogin:b}),[s,u,j,N,y,h,g,v,f,k,b]);return e.jsx(D.Provider,{value:x,children:t})},S=()=>{const t=n.useContext(D);if(!t)throw new Error("useAuth must be used within an AuthProvider");return t},ce=({children:t})=>{const{status:s}=S(),a=T();return s==="loading"?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-sm text-gray-600",children:"Checking your session…"}):s!=="authenticated"?e.jsx(V,{to:"/auth/login",replace:!0,state:{from:a.pathname+a.search+a.hash}}):e.jsx(e.Fragment,{children:t})},de=({requiredRole:t,children:s})=>{const{user:a,status:u,hasRole:l}=S(),o=T();return u==="loading"?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-sm text-gray-600",children:"Checking your permissions…"}):!a||!l(t)?e.jsx(V,{to:"/dashboard",replace:!0,state:{from:o.pathname+o.search+o.hash}}):e.jsx(e.Fragment,{children:s})},M=()=>{var N;const{loginWithEmail:t,startGoogleOAuth:s}=S(),{showToast:a}=A(),u=F(),l=T(),[o,p]=n.useState(""),[c,d]=n.useState(""),[h,g]=n.useState(!1),[v,f]=n.useState(!1),k=((N=l.state)==null?void 0:N.from)||"/dashboard",b=y=>m(void 0,null,function*(){if(y.preventDefault(),!o.trim()||!c.trim()){a({variant:"error",title:"Missing details",description:"Please enter both your email and password."});return}if(!o.includes("@")){a({variant:"error",title:"Invalid email",description:"Please enter a valid email address."});return}f(!0);try{yield t({email:o.trim(),password:c}),u(k,{replace:!0})}catch(x){const r=x;a({variant:"error",title:"Sign in failed",description:(r==null?void 0:r.message)||"Unable to sign you in right now."})}finally{f(!1)}}),j=()=>{s(k)};return e.jsxs("section",{"aria-labelledby":"login-heading",className:"space-y-6",children:[e.jsxs("header",{className:"space-y-1",children:[e.jsx("h1",{id:"login-heading",className:"text-xl font-semibold text-gray-900",children:"Sign in"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Access your SkyCrop dashboard to monitor fields, health, and recommendations."})]}),e.jsx(L,{children:e.jsxs("form",{className:"space-y-4","aria-label":"Login form",onSubmit:b,noValidate:!0,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"email",className:"block text-xs font-medium text-gray-700",children:"Email"}),e.jsx("input",{id:"email",name:"email",type:"email",autoComplete:"email",className:"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",placeholder:"farmer@example.com",value:o,onChange:y=>p(y.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"password",className:"block text-xs font-medium text-gray-700",children:"Password"}),e.jsx("input",{id:"password",name:"password",type:"password",autoComplete:"current-password",className:"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",placeholder:"••••••••",value:c,onChange:y=>d(y.target.value),required:!0})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{id:"remember",name:"remember",type:"checkbox",className:"h-4 w-4 rounded border-gray-300 text-brand-blue focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",checked:h,onChange:y=>g(y.target.checked)}),e.jsx("span",{className:"text-gray-700",children:"Remember me"})]}),e.jsx(I,{to:"/auth/reset-password",className:"text-brand-blue hover:text-blue-600 hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-2 rounded-sm px-0.5",children:"Forgot password?"})]}),e.jsx(P,{type:"submit",variant:"primary",size:"md",className:"mt-2 w-full",disabled:v,children:v?"Signing in…":"Continue"}),e.jsxs("div",{className:"relative my-4",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"w-full border-t border-gray-200"})}),e.jsx("div",{className:"relative flex justify-center text-xs",children:e.jsx("span",{className:"bg-white px-2 text-gray-400",children:"or"})})]}),e.jsx(P,{type:"button",variant:"secondary",size:"md",className:"w-full",onClick:j,children:"Continue with Google"})]})}),e.jsxs("p",{className:"text-xs text-gray-600",children:["New to SkyCrop?"," ",e.jsx(I,{to:"/auth/register",className:"font-medium text-brand-blue hover:text-blue-600 hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-2 rounded-sm px-0.5",children:"Create an account"})]})]})},ue=Object.freeze(Object.defineProperty({__proto__:null,LoginPage:M,default:M},Symbol.toStringTag,{value:"Module"})),W=()=>{const{registerWithEmail:t}=S(),{showToast:s}=A(),a=F(),[u,l]=n.useState(""),[o,p]=n.useState(""),[c,d]=n.useState(""),[h,g]=n.useState(!1),v=f=>m(void 0,null,function*(){if(f.preventDefault(),!u.trim()||!o.trim()||!c.trim()){s({variant:"error",title:"Missing details",description:"Please fill in your name, email, and password."});return}if(!o.includes("@")){s({variant:"error",title:"Invalid email",description:"Please enter a valid email address."});return}if(c.length<8){s({variant:"error",title:"Weak password",description:"Password must be at least 8 characters long."});return}g(!0);try{yield t({name:u.trim(),email:o.trim(),password:c}),a("/dashboard",{replace:!0})}catch(k){const b=k;s({variant:"error",title:"Could not create account",description:(b==null?void 0:b.message)||"Something went wrong while creating your account."})}finally{g(!1)}});return e.jsxs("section",{"aria-labelledby":"register-heading",className:"space-y-6",children:[e.jsxs("header",{className:"space-y-1",children:[e.jsx("h1",{id:"register-heading",className:"text-xl font-semibold text-gray-900",children:"Create an account"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Set up your SkyCrop workspace to start monitoring your fields and crop health."})]}),e.jsx(L,{children:e.jsxs("form",{className:"space-y-4","aria-label":"Registration form",onSubmit:v,noValidate:!0,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"name",className:"block text-xs font-medium text-gray-700",children:"Full name"}),e.jsx("input",{id:"name",name:"name",type:"text",autoComplete:"name",className:"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",placeholder:"A. Farmer",value:u,onChange:f=>l(f.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"email",className:"block text-xs font-medium text-gray-700",children:"Email"}),e.jsx("input",{id:"email",name:"email",type:"email",autoComplete:"email",className:"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",placeholder:"farmer@example.com",value:o,onChange:f=>p(f.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"password",className:"block text-xs font-medium text-gray-700",children:"Password"}),e.jsx("input",{id:"password",name:"password",type:"password",autoComplete:"new-password",className:"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",placeholder:"••••••••",value:c,onChange:f=>d(f.target.value),required:!0}),e.jsx("p",{className:"mt-1 text-[11px] text-gray-500",children:"At least 8 characters, including uppercase, lowercase, and a number."})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"role",className:"block text-xs font-medium text-gray-700",children:"Role (placeholder)"}),e.jsxs("select",{id:"role",name:"role",className:"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",defaultValue:"farmer","aria-disabled":"true",children:[e.jsx("option",{value:"farmer",children:"Farmer"}),e.jsx("option",{value:"admin",disabled:!0,children:"Admin (assigned by system)"})]})]}),e.jsx(P,{type:"submit",variant:"primary",size:"md",className:"mt-2 w-full",disabled:h,children:h?"Creating account…":"Create account"})]})}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Already have an account?"," ",e.jsx(I,{to:"/auth/login",className:"font-medium text-brand-blue hover:text-blue-600 hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-2 rounded-sm px-0.5",children:"Sign in"})]})]})},me=Object.freeze(Object.defineProperty({__proto__:null,RegisterPage:W,default:W},Symbol.toStringTag,{value:"Module"})),G=()=>{const{requestPasswordReset:t,resetPassword:s}=S(),{showToast:a}=A(),u=F(),l=T(),p=new URLSearchParams(l.search).get("token"),c=!!p,[d,h]=n.useState(""),[g,v]=n.useState(""),[f,k]=n.useState(""),[b,j]=n.useState(!1),N=x=>m(void 0,null,function*(){if(x.preventDefault(),!d.trim()){a({variant:"error",title:"Missing email",description:"Please enter the email associated with your account."});return}if(!d.includes("@")){a({variant:"error",title:"Invalid email",description:"Please enter a valid email address."});return}j(!0);try{yield t(d.trim()),a({variant:"success",title:"Check your inbox",description:"If an account exists for this email, a reset link has been sent."})}catch(r){const i=r;a({variant:"error",title:"Could not send reset link",description:(i==null?void 0:i.message)||"Something went wrong while sending the reset link."})}finally{j(!1)}}),y=x=>m(void 0,null,function*(){if(x.preventDefault(),!p){a({variant:"error",title:"Missing reset token",description:"The reset link is invalid or incomplete."});return}if(!g.trim()||!f.trim()){a({variant:"error",title:"Missing password",description:"Please enter and confirm your new password."});return}if(g!==f){a({variant:"error",title:"Passwords do not match",description:"Please make sure both password fields match."});return}if(g.length<8){a({variant:"error",title:"Weak password",description:"Password must be at least 8 characters long."});return}j(!0);try{yield s(p,g),u("/auth/login",{replace:!0})}catch(r){const i=r;a({variant:"error",title:"Could not reset password",description:(i==null?void 0:i.message)||"Something went wrong while updating your password."})}finally{j(!1)}});return e.jsxs("section",{"aria-labelledby":"reset-password-heading",className:"space-y-6",children:[e.jsxs("header",{className:"space-y-1",children:[e.jsx("h1",{id:"reset-password-heading",className:"text-xl font-semibold text-gray-900",children:c?"Choose a new password":"Reset your password"}),e.jsx("p",{className:"text-sm text-gray-600",children:c?"Enter and confirm your new password below.":"Enter the email associated with your account and we'll send a reset link."})]}),e.jsx(L,{children:c?e.jsxs("form",{className:"space-y-4","aria-label":"Set new password form",onSubmit:y,noValidate:!0,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"new-password",className:"block text-xs font-medium text-gray-700",children:"New password"}),e.jsx("input",{id:"new-password",name:"new-password",type:"password",autoComplete:"new-password",className:"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",placeholder:"••••••••",value:g,onChange:x=>v(x.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"confirm-password",className:"block text-xs font-medium text-gray-700",children:"Confirm new password"}),e.jsx("input",{id:"confirm-password",name:"confirm-password",type:"password",autoComplete:"new-password",className:"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",placeholder:"••••••••",value:f,onChange:x=>k(x.target.value),required:!0})]}),e.jsx(P,{type:"submit",variant:"primary",size:"md",className:"mt-2 w-full",disabled:b,children:b?"Updating password…":"Update password"})]}):e.jsxs("form",{className:"space-y-4","aria-label":"Reset password form",onSubmit:N,noValidate:!0,children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"email",className:"block text-xs font-medium text-gray-700",children:"Email"}),e.jsx("input",{id:"email",name:"email",type:"email",autoComplete:"email",className:"block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-1",placeholder:"farmer@example.com",value:d,onChange:x=>h(x.target.value),required:!0})]}),e.jsx(P,{type:"submit",variant:"primary",size:"md",className:"mt-2 w-full",disabled:b,children:b?"Sending reset link…":"Send reset link"})]})}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Remembered your password?"," ",e.jsx(I,{to:"/auth/login",className:"font-medium text-brand-blue hover:text-blue-600 hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-blue focus-visible:ring-offset-2 rounded-sm px-0.5",children:"Return to sign in"})]})]})},he=Object.freeze(Object.defineProperty({__proto__:null,ResetPasswordPage:G,default:G},Symbol.toStringTag,{value:"Module"})),z="skycrop_post_login_redirect",U=()=>{const{completeOAuthLogin:t}=S(),{showToast:s}=A(),a=F(),u=T(),[l,o]=n.useState("Signing you in with Google…");return n.useEffect(()=>{const c=new URLSearchParams(u.search).get("token");m(void 0,null,function*(){if(!c){o("Missing token in callback URL."),s({variant:"error",title:"Google sign-in failed",description:"We could not complete sign-in because the token was missing."}),a("/auth/login",{replace:!0});return}try{yield t(c);const h=window.sessionStorage.getItem(z)||"/dashboard";window.sessionStorage.removeItem(z),a(h,{replace:!0})}catch(h){const g=h;o("Google sign-in failed."),s({variant:"error",title:"Google sign-in failed",description:(g==null?void 0:g.message)||"Something went wrong while completing sign-in."}),a("/auth/login",{replace:!0})}})},[u.search,t,a,s]),e.jsxs("section",{"aria-labelledby":"oauth-callback-heading",className:"space-y-6",children:[e.jsxs("header",{className:"space-y-1",children:[e.jsx("h1",{id:"oauth-callback-heading",className:"text-xl font-semibold text-gray-900",children:"Completing sign-in"}),e.jsx("p",{className:"text-sm text-gray-600",children:l})]}),e.jsx(L,{children:e.jsxs("div",{className:"flex items-center gap-3 text-sm text-gray-700",children:[e.jsxs("svg",{className:"h-5 w-5 animate-spin text-brand-blue",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","aria-hidden":"true",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]}),e.jsx("span",{children:"Please wait while we finish signing you in…"})]})})]})},ge=Object.freeze(Object.defineProperty({__proto__:null,OAuthCallbackPage:U,default:U},Symbol.toStringTag,{value:"Module"}));export{le as A,ue as L,ge as O,ce as R,de as a,me as b,he as c,S as u};
